<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بيانات اتصال مالك القطة الضائعة</title>
    
    <!-- Your existing CSS links -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">

    <!-- Firebase SDK Modules -->
    <script type="module">
        // Import the required Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDAaBVq8Cje-XYuNjxgJZkuKlGZlbCPwQI",
            authDomain: "lostcattest-1.firebaseapp.com",
            projectId: "lostcattest-1",
            storageBucket: "lostcattest-1.firebasestorage.app",
            messagingSenderId: "801235048233",
            appId: "1:801235048233:web:39f8ced879ea0dd3e70938"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global storage implementation using Firestore
        window.globalStorage = {
            data: {},
            subscribers: [],

            // Store data in Firestore
            setItem: async function(key, value) {
                try {
                    const userDocRef = doc(db, 'catOwners', 'userData');
                    await setDoc(userDocRef, { [key]: value }, { merge: true });
                    this.data[key] = value;
                    this.notifySubscribers(key, value);
                } catch (error) {
                    console.error('Error storing data in Firestore:', error);
                    localStorage.setItem(key, value);
                }
            },

            // Retrieve data from Firestore
            getItem: async function(key) {
                try {
                    const userDocRef = doc(db, 'catOwners', 'userData');
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        return data[key];
                    }
                    return null;
                } catch (error) {
                    console.error('Error fetching data from Firestore:', error);
                    return localStorage.getItem(key);
                }
            },

            // Subscribe to real-time updates
            subscribeToChanges: function() {
                const userDocRef = doc(db, 'catOwners', 'userData');
                onSnapshot(userDocRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        Object.keys(data).forEach(key => {
                            this.notifySubscribers(key, data[key]);
                        });
                    }
                }, (error) => {
                    console.error('Error listening to Firestore changes:', error);
                });
            },

            // Subscribe to changes
            subscribe: function(callback) {
                this.subscribers.push(callback);
            },

            // Notify subscribers of changes
            notifySubscribers: function(key, value) {
                this.subscribers.forEach(callback => callback(key, value));
            }
        };

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', async function() {
            const formContainer = document.getElementById('formContainer');
            const dataContainer = document.getElementById('dataContainer');
            const displayName = document.getElementById('displayName');
            const displayPhone = document.getElementById('displayPhone');

            // Start listening for real-time updates
            window.globalStorage.subscribeToChanges();

            try {
                const userName = await window.globalStorage.getItem('userName');
                const userPhone = await window.globalStorage.getItem('userPhone');

                if (userName && userPhone) {
                    formContainer.style.display = 'none';
                    dataContainer.style.display = 'flex';
                    displayName.textContent = userName;
                    displayPhone.textContent = userPhone;
                } else {
                    formContainer.style.display = 'flex';
                    dataContainer.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading data:', error);
                formContainer.style.display = 'flex';
                dataContainer.style.display = 'none';
            }

            // Save button click handler
            document.getElementById('saveBtn').addEventListener('click', async function() {
                const name = document.getElementById('name').value;
                const phone = document.getElementById('phone').value;

                if (name && phone) {
                    const btn = this;
                    btn.disabled = true;

                    try {
                        await window.globalStorage.setItem('userName', name);
                        await window.globalStorage.setItem('userPhone', phone);

                        btn.innerHTML = '<i class="fas fa-check"></i> تم الحفظ!';
                        btn.style.background = 'linear-gradient(90deg, var(--success), #01c896)';

                        setTimeout(() => {
                            btn.innerHTML = 'حفظ البيانات <i class="fas fa-save"></i>';
                            btn.style.background = 'linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%)';
                            btn.disabled = false;

                            formContainer.style.display = 'none';
                            dataContainer.style.display = 'flex';
                            displayName.textContent = name;
                            displayPhone.textContent = phone;
                        }, 1500);
                    } catch (error) {
                        console.error('Error saving data:', error);
                        // Show error message
                        const alertMsg = document.createElement('div');
                        alertMsg.innerHTML = '<i class="fas fa-exclamation-circle"></i> حدث خطأ أثناء حفظ البيانات';
                        alertMsg.style.cssText = `
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: var(--accent);
                            color: white;
                            padding: 15px 25px;
                            border-radius: 10px;
                            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                            z-index: 1000;
                            animation: slideIn 0.5s, fadeOut 0.5s 2.5s;
                        `;
                        
                        document.body.appendChild(alertMsg);
                        
                        setTimeout(() => {
                            alertMsg.remove();
                            btn.disabled = false;
                        }, 3000);
                    }
                }
            });

            // Edit button click handler
            document.getElementById('editBtn').addEventListener('click', async function() {
                dataContainer.style.animation = 'fadeOut 0.5s';
                
                setTimeout(async () => {
                    formContainer.style.display = 'flex';
                    dataContainer.style.display = 'none';
                    dataContainer.style.animation = '';
                    
                    try {
                        const userName = await window.globalStorage.getItem('userName');
                        const userPhone = await window.globalStorage.getItem('userPhone');
                        document.getElementById('name').value = userName || '';
                        document.getElementById('phone').value = userPhone || '';
                    } catch (error) {
                        console.error('Error loading data for editing:', error);
                    }
                    
                    formContainer.style.animation = 'fadeIn 0.5s';
                    
                    setTimeout(() => {
                        formContainer.style.animation = '';
                    }, 500);
                }, 500);
            });
        });
    </script>

    <!-- [Your existing styles remain the same] -->
</head>
<!-- [Rest of your HTML remains the same] -->
